<!DOCTYPE html><html><head><title>EXTScope.h</title><meta http-equiv="content-type" content="text/html; charset=UTF-8"><link rel="stylesheet" media="all" href="doc-style.css"><script src="doc-filelist.js"></script><script>var relativeDir = '', thisFile = '/Users/bryn/.otis/templates/tmpl.jade', defaultSidebar = true;</script><script src="doc-script.js"></script></head><body><div id="sidebar_wrapper"><div id="sidebar_switch"><span class="tree">Files</span><span class="headings">Headings</span></div><div id="tree"></div><div id="headings"></div></div><div id="sidebar-toggle"></div><div id="container"><div class="background highlight"></div><table cellpadding="0" cellspacing="0"><tbody><tr><td class="docs"></td><td class="code highlight"></td></tr><tr><td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-1" id="section-1">&#182;</a>
</div>
</td><td class="code highlight"><div class="highlight"><pre><span class="c1">//</span>
<span class="c1">//  EXTScope.h</span>
<span class="c1">//  extobjc</span>
<span class="c1">//</span>
<span class="c1">//  Created by Justin Spahr-Summers on 2011-05-04.</span>
<span class="c1">//  Copyright (C) 2012 Justin Spahr-Summers.</span>
<span class="c1">//  Released under the MIT license.</span>
<span class="c1">//</span>

<span class="cp">#import &quot;metamacros.h&quot;</span>

<span class="cm">/**</span>
<span class="cm"> * \@onExit defines some code to be executed when the current scope exits. The</span>
<span class="cm"> * code must be enclosed in braces and terminated with a semicolon, and will be</span>
<span class="cm"> * executed regardless of how the scope is exited, including from exceptions,</span>
<span class="cm"> * \c goto, \c return, \c break, and \c continue.</span>
<span class="cm"> *</span>
<span class="cm"> * Provided code will go into a block to be executed later. Keep this in mind as</span>
<span class="cm"> * it pertains to memory management, restrictions on assignment, etc. Because</span>
<span class="cm"> * the code is used within a block, \c return is a legal (though perhaps</span>
<span class="cm"> * confusing) way to exit the cleanup block early.</span>
<span class="cm"> *</span>
<span class="cm"> * Multiple \@onExit statements in the same scope are executed in reverse</span>
<span class="cm"> * lexical order. This helps when pairing resource acquisition with \@onExit</span>
<span class="cm"> * statements, as it guarantees teardown in the opposite order of acquisition.</span>
<span class="cm"> *</span>
<span class="cm"> * @note This statement cannot be used within scopes defined without braces</span>
<span class="cm"> * (like a one line \c if). In practice, this is not an issue, since \@onExit is</span>
<span class="cm"> * a useless construct in such a case anyways.</span>
<span class="cm"> */</span>
<span class="cp">#define onExit \</span>
<span class="cp">    try {} @finally {} \</span>
<span class="cp">    __strong ext_cleanupBlock_t metamacro_concat(ext_exitBlock_, __LINE__) __attribute__((cleanup(ext_executeCleanupBlock), unused)) = ^</span>

<span class="cm">/**</span>
<span class="cm"> * Creates \c __weak shadow variables for each of the variables provided as</span>
<span class="cm"> * arguments, which can later be made strong again with #strongify.</span>
<span class="cm"> *</span>
<span class="cm"> * This is typically used to weakly reference variables in a block, but then</span>
<span class="cm"> * ensure that the variables stay alive during the actual execution of the block</span>
<span class="cm"> * (if they were live upon entry).</span>
<span class="cm"> *</span>
<span class="cm"> * See #strongify for an example of usage.</span>
<span class="cm"> */</span>
<span class="cp">#define weakify(...) \</span>
<span class="cp">    try {} @finally {} \</span>
<span class="cp">    metamacro_foreach_cxt(ext_weakify_,, __weak, __VA_ARGS__)</span>

<span class="cm">/**</span>
<span class="cm"> * Like #weakify, but uses \c __unsafe_unretained instead, for targets or</span>
<span class="cm"> * classes that do not support weak references.</span>
<span class="cm"> */</span>
<span class="cp">#define unsafeify(...) \</span>
<span class="cp">    try {} @finally {} \</span>
<span class="cp">    metamacro_foreach_cxt(ext_weakify_,, __unsafe_unretained, __VA_ARGS__)</span>

<span class="cm">/**</span>
<span class="cm"> * Strongly references each of the variables provided as arguments, which must</span>
<span class="cm"> * have previously been passed to #weakify.</span>
<span class="cm"> *</span>
<span class="cm"> * The strong references created will shadow the original variable names, such</span>
<span class="cm"> * that the original names can be used without issue (and a significantly</span>
<span class="cm"> * reduced risk of retain cycles) in the current scope.</span>
<span class="cm"> *</span>
<span class="cm"> * @code</span>

<span class="cm">    id foo = [[NSObject alloc] init];</span>
<span class="cm">    id bar = [[NSObject alloc] init];</span>

<span class="cm">    @weakify(foo, bar);</span>

<span class="cm">    // this block will not keep &#39;foo&#39; or &#39;bar&#39; alive</span>
<span class="cm">    BOOL (^matchesFooOrBar)(id) = ^ BOOL (id obj){</span>
<span class="cm">        // but now, upon entry, &#39;foo&#39; and &#39;bar&#39; will stay alive until the block has</span>
<span class="cm">        // finished executing</span>
<span class="cm">        @strongify(foo, bar);</span>

<span class="cm">        return [foo isEqual:obj] || [bar isEqual:obj];</span>
<span class="cm">    };</span>

<span class="cm"> * @endcode</span>
<span class="cm"> */</span>
<span class="cp">#define strongify(...) \</span>
<span class="cp">    try {} @finally {} \</span>
<span class="cp">    metamacro_foreach(ext_strongify_,, __VA_ARGS__)</span>

<span class="cm">/*** implementation details follow ***/</span>
<span class="k">typedef</span> <span class="nf">void</span> <span class="p">(</span><span class="o">^</span><span class="n">ext_cleanupBlock_t</span><span class="p">)();</span>

<span class="kt">void</span> <span class="nf">ext_executeCleanupBlock</span> <span class="p">(</span><span class="n">__strong</span> <span class="n">ext_cleanupBlock_t</span> <span class="o">*</span><span class="n">block</span><span class="p">);</span>

<span class="cp">#define ext_weakify_(INDEX, CONTEXT, VAR) \</span>
<span class="cp">    CONTEXT __typeof__(VAR) metamacro_concat(VAR, _weak_) = (VAR);</span>

<span class="cp">#define ext_strongify_(INDEX, VAR) \</span>
<span class="cp">    __strong __typeof__(VAR) VAR = metamacro_concat(VAR, _weak_);</span>
</pre></div></td></tr></tbody></table></div></body></html>